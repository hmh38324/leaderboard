// ÊéíË°åÊ¶úÈ°µÈù¢JavaScript

// Ê∏∏ÊàèÈÖçÁΩÆ
const GAMES = {
    1: { name: 'ÊãºÈÄüËææ‰∫∫', icon: '‚ö°', description: 'ÂÆàÊìÇÊåëÊàò' },
    2: { name: 'Á¢∞Á¢∞‰πê', icon: 'üöó', description: 'ÈÅ•ÊéßÂØπÊàò' },
    3: { name: 'Ê≤ôÂåÖÊäïÊé∑', icon: 'üéØ', description: 'Á≤æÂáÜÊäïÊé∑' },
    4: { name: 'Â∑ßÊâãÂèñÊ£í', icon: 'ü•¢', description: 'Á≤æÂáÜÊäìÂèñ' }
};

// API Âü∫Á°Ä URL
const API_BASE = 'https://addscoreapi.biboran.top/api';

// ÂÖ®Â±ÄÂèòÈáè
let allScores = [];
let currentGameFilter = 'all';
let leaderboardData = [];

// DOM ÂÖÉÁ¥†
const loading = document.getElementById('loading');
const message = document.getElementById('message');
const totalParticipants = document.getElementById('totalParticipants');
const totalSubmissions = document.getElementById('totalSubmissions');
const totalScore = document.getElementById('totalScore');
const leaderboardTitle = document.getElementById('leaderboardTitle');
const leaderboardCount = document.getElementById('leaderboardCount');
const leaderboardList = document.getElementById('leaderboardList');
const emptyState = document.getElementById('emptyState');
const gameDetailModal = document.getElementById('gameDetailModal');
const gameDetailTitle = document.getElementById('gameDetailTitle');
const gameStats = document.getElementById('gameStats');
const recentScores = document.getElementById('recentScores');
// ËÆæÁΩÆÁõ∏ÂÖ≥ÂÖÉÁ¥†
const settingsModal = document.getElementById('settingsModal');
const settingsAuth = document.getElementById('settingsAuth');
const settingsPanel = document.getElementById('settingsPanel');
const settingsPasswordInput = document.getElementById('settingsPassword');
const trialLockedToggleEl = document.getElementById('trialLockedToggle');
const arenaLockedToggleEl = document.getElementById('arenaLockedToggle');

// ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    loadLeaderboardData();
    fetchFlagsAndApply();
});

// ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
function setupEventListeners() {
    // Ê∏∏ÊàèÈÄâÊã©Âô®
    document.querySelectorAll('.game-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const gameId = this.dataset.game;
            selectGame(gameId);
        });
    });

    // ÂÖ≥Èó≠Ê∏∏ÊàèËØ¶ÊÉÖÂºπÁ™ó
    gameDetailModal.addEventListener('click', function(e) {
        if (e.target === gameDetailModal) {
            closeGameDetail();
        }
    });

    // ESC ÈîÆÂÖ≥Èó≠ÂºπÁ™ó
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeGameDetail();
        }
    });
}

// ÈÄâÊã©Ê∏∏Êàè
function selectGame(gameId) {
    // Êõ¥Êñ∞Ê†áÁ≠æÁä∂ÊÄÅ
    document.querySelectorAll('.game-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-game="${gameId}"]`).classList.add('active');

    currentGameFilter = gameId;
    updateLeaderboard();
}

// Âä†ËΩΩÊéíË°åÊ¶úÊï∞ÊçÆ
async function loadLeaderboardData() {
    showLoading(true);
    
    try {
        // Ëé∑ÂèñÊâÄÊúâÁßØÂàÜËÆ∞ÂΩï
        const response = await fetch(`${API_BASE}/scores`);
        if (!response.ok) {
            throw new Error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•');
        }
        
        const result = await response.json();
        if (result.success && result.data) {
            allScores = result.data;
            processLeaderboardData();
            updateLeaderboard();
            updateStats();
        } else {
            throw new Error('Êï∞ÊçÆÊ†ºÂºèÈîôËØØ');
        }
        
    } catch (error) {
        console.error('Âä†ËΩΩÊéíË°åÊ¶úÊï∞ÊçÆÂ§±Ë¥•:', error);
        showMessage('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
    } finally {
        showLoading(false);
    }
}

// Â§ÑÁêÜÊéíË°åÊ¶úÊï∞ÊçÆ
function processLeaderboardData() {
    const playerScores = {};
    
    // ÊåâÂëòÂ∑•ÂàÜÁªÑËÆ°ÁÆóÊÄªÂàÜ
    allScores.forEach(score => {
        const key = `${score.employee_id}_${score.employee_name}`;
        if (!playerScores[key]) {
            playerScores[key] = {
                employeeId: score.employee_id,
                employeeName: score.employee_name,
                totalScore: 0,
                gameScores: {},
                lastPlayTime: null
            };
        }
        
        playerScores[key].totalScore += score.score;
        playerScores[key].gameScores[score.game_id] = (playerScores[key].gameScores[score.game_id] || 0) + score.score;
        
        const playTime = new Date(score.created_at);
        if (!playerScores[key].lastPlayTime || playTime > playerScores[key].lastPlayTime) {
            playerScores[key].lastPlayTime = playTime;
        }
    });
    
    // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂ÊéíÂ∫è
    leaderboardData = Object.values(playerScores).sort((a, b) => {
        if (b.totalScore !== a.totalScore) {
            return b.totalScore - a.totalScore;
        }
        // ÊÄªÂàÜÁõ∏ÂêåÊó∂ÊåâÊúÄÂêéÊ∏∏ÊàèÊó∂Èó¥ÊéíÂ∫è
        return b.lastPlayTime - a.lastPlayTime;
    });
}

// Êõ¥Êñ∞ÊéíË°åÊ¶úÊòæÁ§∫
function updateLeaderboard() {
    let filteredData = leaderboardData;
    let title = 'ÂÖ®ÈÉ®Ê∏∏ÊàèÊéíË°åÊ¶ú';
    
    if (currentGameFilter !== 'all') {
        const gameId = parseInt(currentGameFilter);
        const game = GAMES[gameId];
        title = `${game.icon} ${game.name} ÊéíË°åÊ¶ú`;
        
        // ËøáÊª§Âè™ÊòæÁ§∫ÊúâËØ•Ê∏∏ÊàèÁßØÂàÜÁöÑÁé©ÂÆ∂
        filteredData = leaderboardData.filter(player => 
            player.gameScores[gameId] && player.gameScores[gameId] > 0
        );
        
        // ÊåâËØ•Ê∏∏ÊàèÁßØÂàÜÊéíÂ∫è
        filteredData.sort((a, b) => {
            const scoreA = a.gameScores[gameId] || 0;
            const scoreB = b.gameScores[gameId] || 0;
            if (scoreB !== scoreA) {
                return scoreB - scoreA;
            }
            return b.lastPlayTime - a.lastPlayTime;
        });
    }
    
    leaderboardTitle.textContent = title;
    leaderboardCount.textContent = `${filteredData.length} ‰∫∫ÂèÇ‰∏é`;
    
    if (filteredData.length === 0) {
        leaderboardList.innerHTML = '';
        emptyState.classList.remove('hidden');
    } else {
        emptyState.classList.add('hidden');
        displayLeaderboard(filteredData);
    }
}

// ÊòæÁ§∫ÊéíË°åÊ¶ú
function displayLeaderboard(data) {
    leaderboardList.innerHTML = data.map((player, index) => {
        const rank = index + 1;
        const rankClass = rank <= 3 ? `rank-${rank}` : '';
        
        let gameScoresHtml = '';
        if (currentGameFilter === 'all') {
            // ÊòæÁ§∫ÊâÄÊúâÊ∏∏ÊàèÁöÑÁßØÂàÜ
            Object.keys(player.gameScores).forEach(gameId => {
                const game = GAMES[gameId];
                const score = player.gameScores[gameId];
                if (score > 0) {
                    gameScoresHtml += `
                        <div class="game-score">
                            ${game.icon} ${score}
                        </div>
                    `;
                }
            });
        } else {
            // ÊòæÁ§∫ÂΩìÂâçÊ∏∏ÊàèÁöÑÁßØÂàÜ
            const gameId = parseInt(currentGameFilter);
            const game = GAMES[gameId];
            const score = player.gameScores[gameId] || 0;
            gameScoresHtml = `
                <div class="game-score">
                    ${game.icon} ${score}
                </div>
            `;
        }
        
        const displayScore = currentGameFilter === 'all' 
            ? player.totalScore 
            : (player.gameScores[parseInt(currentGameFilter)] || 0);
        
        return `
            <div class="leaderboard-item ${rankClass}" onclick="showPlayerDetail('${player.employeeId}', '${player.employeeName}')">
                <div class="rank-number">${rank}</div>
                <div class="player-info">
                    <h3 class="player-name">${player.employeeName}</h3>
                    <p class="player-id">Â∑•Âè∑: ${player.employeeId}</p>
                </div>
                <div class="score-info">
                    <div class="total-score">${displayScore}</div>
                    <div class="game-scores">${gameScoresHtml}</div>
                </div>
            </div>
        `;
    }).join('');
}

// Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
function updateStats() {
    const totalPlayers = leaderboardData.length;
    const totalSubmissionsCount = allScores.length;
    const totalScoreSum = allScores.reduce((sum, score) => sum + score.score, 0);
    
    totalParticipants.textContent = totalPlayers;
    totalSubmissions.textContent = totalSubmissionsCount;
    totalScore.textContent = totalScoreSum;
}

// ÊòæÁ§∫Áé©ÂÆ∂ËØ¶ÊÉÖ
function showPlayerDetail(employeeId, employeeName) {
    const player = leaderboardData.find(p => p.employeeId === employeeId);
    if (!player) return;
    
    gameDetailTitle.textContent = `${employeeName} (${employeeId}) ÁöÑÊ∏∏ÊàèËØ¶ÊÉÖ`;
    
    // ÊòæÁ§∫Ê∏∏ÊàèÁªüËÆ°
    const gameStatsHtml = Object.keys(player.gameScores).map(gameId => {
        const game = GAMES[gameId];
        const score = player.gameScores[gameId];
        return `
            <div class="game-stat-item">
                <div class="game-stat-number">${score}</div>
                <p class="game-stat-label">${game.icon} ${game.name}</p>
            </div>
        `;
    }).join('');
    
    gameStats.innerHTML = gameStatsHtml;
    
    // ÊòæÁ§∫ÊúÄËøëÁßØÂàÜËÆ∞ÂΩï
    const playerScores = allScores
        .filter(score => score.employee_id === employeeId)
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .slice(0, 10);
    
    const recentScoresHtml = playerScores.map(score => {
        const game = GAMES[score.game_id];
        const time = new Date(score.created_at).toLocaleString('zh-CN');
        return `
            <div class="recent-score-item">
                <div class="recent-score-info">
                    <div class="recent-score-name">${game.icon} ${game.name}</div>
                    <div class="recent-score-time">${time}</div>
                </div>
                <div class="recent-score-value">+${score.score}</div>
            </div>
        `;
    }).join('');
    
    recentScores.innerHTML = `
        <h3>ÊúÄËøëÁßØÂàÜËÆ∞ÂΩï</h3>
        ${recentScoresHtml || '<p style="color: #666; text-align: center;">ÊöÇÊó†ËÆ∞ÂΩï</p>'}
    `;
    
    gameDetailModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

// ÂÖ≥Èó≠Ê∏∏ÊàèËØ¶ÊÉÖ
function closeGameDetail() {
    gameDetailModal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Âà∑Êñ∞ÊéíË°åÊ¶ú
function refreshLeaderboard() {
    loadLeaderboardData();
}

// ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
function showLoading(show) {
    if (show) {
        loading.classList.remove('hidden');
    } else {
        loading.classList.add('hidden');
    }
}

// ÊòæÁ§∫Ê∂àÊÅØ
function showMessage(text, type = 'success') {
    message.textContent = text;
    message.className = `message ${type}`;
    message.classList.remove('hidden');
    
    setTimeout(() => {
        message.classList.add('hidden');
    }, 3000);
}

// Ëá™Âä®Âà∑Êñ∞ÔºàÊØè30ÁßíÔºâ
setInterval(() => {
    if (document.visibilityState === 'visible') {
        loadLeaderboardData();
    }
}, 30000);

// ÂØºÂá∫ÊÄªÊéíË°åÊ¶úÔºàCSVÔºâ
function exportTotalLeaderboard() {
    const password = prompt('ËØ∑ËæìÂÖ•ÂØºÂá∫ÂØÜÁ†Å');
    if (password === null) {
        return;
    }
    if (password !== '1314520') {
        showMessage('ÂØÜÁ†ÅÈîôËØØÔºåÊó†Ê≥ïÂØºÂá∫', 'error');
        return;
    }

    if (!leaderboardData || leaderboardData.length === 0) {
        showMessage('ÊöÇÊó†Êï∞ÊçÆÂèØÂØºÂá∫', 'error');
        return;
    }

    // ÊûÑÂª∫Ë°®Â§¥
    const headers = ['ÊéíÂêç', 'Â∑•Âè∑', 'ÂßìÂêç', 'ÊÄªÂàÜ', 'ÊãºÈÄüËææ‰∫∫', 'Á¢∞Á¢∞‰πê', 'Ê≤ôÂåÖÊäïÊé∑', 'Â∑ßÊâãÂèñÊ£í', 'ÊúÄÂêéÊ∏∏ÊàèÊó∂Èó¥'];

    // Á°Æ‰øù‰ª•ÊÄªÂàÜÊéíÂ∫èÔºà‰∏éÊÄªÊ¶ú‰∏ÄËá¥Ôºâ
    const data = [...leaderboardData].sort((a, b) => {
        if (b.totalScore !== a.totalScore) return b.totalScore - a.totalScore;
        return b.lastPlayTime - a.lastPlayTime;
    });

    // ËΩ¨Êç¢‰∏∫CSV
    const rows = data.map((player, index) => {
        const game1 = player.gameScores[1] || 0;
        const game2 = player.gameScores[2] || 0;
        const game3 = player.gameScores[3] || 0;
        const game4 = player.gameScores[4] || 0;
        const time = player.lastPlayTime ? new Date(player.lastPlayTime).toLocaleString('zh-CN') : '';
        const row = [
            index + 1,
            player.employeeId,
            player.employeeName,
            player.totalScore,
            game1,
            game2,
            game3,
            game4,
            time
        ];
        return row.map(v => {
            const s = String(v).replace(/"/g, '""');
            if (/[",\n]/.test(s)) {
                return `"${s}` + '"';
            }
            return s;
        }).join(',');
    });

    const csvContent = ['\ufeff' + headers.join(','), ...rows].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    const ts = new Date();
    const tsStr = `${ts.getFullYear()}-${String(ts.getMonth() + 1).padStart(2, '0')}-${String(ts.getDate()).padStart(2, '0')}_${String(ts.getHours()).padStart(2, '0')}${String(ts.getMinutes()).padStart(2, '0')}`;
    a.href = url;
    a.download = `ÊÄªÊéíË°åÊ¶ú_${tsStr}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    showMessage('ÂØºÂá∫ÊàêÂäüÔºåÂ∑≤ÂºÄÂßã‰∏ãËΩΩ');
}

// ÂÖºÂÆπÊüê‰∫õÁéØÂ¢ÉÁöÑÂÖ®Â±Ä‰ΩúÁî®ÂüüÈôêÂà∂
if (typeof window !== 'undefined') {
    window.exportTotalLeaderboard = exportTotalLeaderboard;
}

// ËÆæÁΩÆÈù¢ÊùøÈÄªËæë
function openSettings() {
    // ÊØèÊ¨°ÊâìÂºÄÈÉΩË¶ÅÊ±ÇËæìÂÖ•ÂØÜÁ†Å
    if (settingsAuth) settingsAuth.classList.remove('hidden');
    if (settingsPanel) settingsPanel.classList.add('hidden');
    if (settingsPasswordInput) settingsPasswordInput.value = '';
    if (settingsModal) settingsModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeSettings() {
    if (settingsModal) settingsModal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

function verifySettingsPassword() {
    const val = (settingsPasswordInput && settingsPasswordInput.value) || '';
    if (val === '1314520') {
        if (settingsAuth) settingsAuth.classList.add('hidden');
        if (settingsPanel) settingsPanel.classList.remove('hidden');
        // ÂêåÊ≠•ÊúçÂä°Á´ØÈîÅÂÆöÁä∂ÊÄÅÂà∞ÂºÄÂÖ≥
        fetchFlagsAndApply();
        showMessage('ËÆæÁΩÆÂ∑≤Ëß£ÈîÅ');
    } else {
        showMessage('ÂØÜÁ†ÅÈîôËØØ', 'error');
    }
}

async function toggleTrialLocked(locked) {
    await updateFlags({ trialLocked: locked });
}

async function toggleArenaLocked(locked) {
    await updateFlags({ arenaLocked: locked });
}

if (typeof window !== 'undefined') {
    window.openSettings = openSettings;
    window.closeSettings = closeSettings;
    window.verifySettingsPassword = verifySettingsPassword;
    window.toggleTrialLocked = toggleTrialLocked;
    window.toggleArenaLocked = toggleArenaLocked;
}

// ‰ªéÊúçÂä°Á´ØËé∑ÂèñÈîÅÁä∂ÊÄÅÂπ∂Â∫îÁî®Âà∞ÁïåÈù¢
async function fetchFlagsAndApply() {
    try {
        const res = await fetch('/api/flags');
        const json = await res.json();
        if (json && json.success && json.data) {
            const { trialLocked, arenaLocked } = json.data;
            if (trialLockedToggleEl) trialLockedToggleEl.checked = !!trialLocked;
            if (arenaLockedToggleEl) arenaLockedToggleEl.checked = !!arenaLocked;
            // Â¶ÇÈúÄÊ†πÊçÆÈîÅÁä∂ÊÄÅÈöêËóèÊàñÁ¶ÅÁî®È°µÈù¢ÂÖÉÁ¥†ÔºåÂèØÂú®Ê≠§Â§ÑÁêÜ
        }
    } catch (e) {
        console.error('Ëé∑ÂèñÈîÅÁä∂ÊÄÅÂ§±Ë¥•', e);
    }
}

// Êõ¥Êñ∞ÊúçÂä°Á´ØÈîÅÁä∂ÊÄÅ
async function updateFlags(partial) {
    try {
        const current = await (async () => {
            try {
                const r = await fetch('/api/flags');
                const j = await r.json();
                return (j && j.success && j.data) ? j.data : { trialLocked: false, arenaLocked: false };
            } catch { return { trialLocked: false, arenaLocked: false }; }
        })();
        const next = { ...current, ...partial };
        const res = await fetch('/api/flags', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ ...next, password: '1314520' })
        });
        const json = await res.json();
        if (json && json.success) {
            if (trialLockedToggleEl) trialLockedToggleEl.checked = !!json.data.trialLocked;
            if (arenaLockedToggleEl) arenaLockedToggleEl.checked = !!json.data.arenaLocked;
            showMessage('ËÆæÁΩÆÂ∑≤Êõ¥Êñ∞');
        } else {
            showMessage('Êõ¥Êñ∞Â§±Ë¥•', 'error');
        }
    } catch (e) {
        console.error('Êõ¥Êñ∞ÈîÅÁä∂ÊÄÅÂ§±Ë¥•', e);
        showMessage('ÁΩëÁªúÈîôËØØÔºåÊõ¥Êñ∞Â§±Ë¥•', 'error');
    }
}
